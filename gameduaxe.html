<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Neon Car Dodge PRO</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #000; overflow: hidden; font-family: 'Orbitron', sans-serif;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      height: 100vh; color: #0ff; perspective: 1000px;
    }
    canvas {
      border: 4px solid #0ff; border-radius: 15px;
      box-shadow: 0 0 50px #0ff, inset 0 0 30px rgba(0,255,255,0.3);
      transform: rotateX(15deg); image-rendering: pixelated;
    }
    .ui {
      position: absolute; top: 20px; left: 20px; z-index: 10; text-shadow: 0 0 10px #0ff;
    }
    .score { font-size: 28px; font-weight: bold; }
    .highscore { font-size: 18px; margin-top: 5px; color: #f0f; }
    .game-over {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      text-align: center; color: #f33; font-size: 50px; font-weight: bold;
      text-shadow: 0 0 20px #f33; display: none; z-index: 20;
    }
    .restart {
      margin-top: 20px; padding: 15px 40px; background: #0ff; color: #000;
      border: none; border-radius: 15px; font-size: 20px; font-weight: bold;
      cursor: pointer; box-shadow: 0 0 30px #0ff; transition: 0.3s;
    }
    .restart:hover { background: #0cc; transform: scale(1.1); }
    .speed { position: absolute; bottom: 20px; right: 20px; font-size: 24px; color: #ff0; text-shadow: 0 0 10px #ff0; }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
</head>
<body>
  <div class="ui">
    <div class="score">Score: <span id="score">0</span></div>
    <div class="highscore">Best: <span id="highscore">0</span></div>
  </div>
  <div class="speed">Speed: <span id="speed">1.0x</span></div>
  <canvas id="gameCanvas" width="450" height="650"></canvas>

  <div class="game-over" id="gameOver">
    <div>CRASHED!</div>
    <div style="font-size:28px; margin:15px 0;">Score: <span id="finalScore">0</span></div>
    <button class="restart" onclick="restartGame()">PLAY AGAIN</button>
  </div>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score');
    const highscoreEl = document.getElementById('highscore');
    const finalScoreEl = document.getElementById('finalScore');
    const speedEl = document.getElementById('speed');
    const gameOverScreen = document.getElementById('gameOver');

    // Âm thanh
    const sounds = {
      engine: new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYA...'), // (âm thanh động cơ)
      crash: new Audio('data:audio/wav;base64,UklGRl4AAABXQVZFZm10IBIAAAABAAEARKwAAIhYA...'),
      bgm: new Audio('data:audio/wav;base64,UklGRnoDAABXQVZFZm10IBIAAAABAAEARKwAAIhYA...')
    };
    sounds.bgm.loop = true; sounds.bgm.volume = 0.3;

    let player = { x: 200, y: 500, width: 50, height: 80, speed: 10, trail: [] };
    let obstacles = [];
    let particles = [];
    let stars = [];
    let score = 0;
    let gameSpeed = 5;
    let gameActive = true;
    let highscore = localStorage.getItem('neonHighscore') || 0;
    highscoreEl.textContent = highscore;

    // Tạo sao nền
    for (let i = 0; i < 100; i++) {
      stars.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        size: Math.random() * 2,
        speed: Math.random() * 3 + 1
      });
    }

    function createObstacle() {
      const lane = Math.floor(Math.random() * 3);
      const x = 120 + lane * 90;
      obstacles.push({
        x, y: -120, width: 60, height: 100,
        speed: gameSpeed + Math.random() * 3,
        glow: `hsl(${Math.random()*60 + 300}, 100%, 70%)`
      });
    }

    function createExplosion(x, y) {
      for (let i = 0; i < 30; i++) {
        particles.push({
          x, y,
          vx: (Math.random() - 0.5) * 20,
          vy: (Math.random() - 0.5) * 20,
          life: 40,
          color: ['#f33', '#ff0', '#f90'][Math.floor(Math.random()*3)],
          size: Math.random() * 6 + 3
        });
      }
      sounds.crash.currentTime = 0; sounds.crash.play();
      canvas.style.animation = 'shake 0.3s';
      setTimeout(() => canvas.style.animation = '', 300);
    }

    function draw3DRoad() {
      const horizon = 200;
      const roadWidth = 300;
      ctx.fillStyle = '#111';
      ctx.beginPath();
      ctx.moveTo(0, horizon);
      ctx.lineTo(canvas.width, horizon);
      ctx.lineTo(canvas.width, canvas.height);
      ctx.lineTo(0, canvas.height);
      ctx.closePath();
      ctx.fill();

      // Vạch đường
      ctx.strokeStyle = '#0ff';
      ctx.lineWidth = 4;
      for (let i = 0; i < 15; i++) {
        const y = (i * 60 + Date.now() * 0.1) % (canvas.height + 100);
        const w = roadWidth * (1 - (y - horizon) / (canvas.height - horizon));
        const x = (canvas.width - w) / 2;
        ctx.beginPath();
        ctx.setLineDash([30, 30]);
        ctx.moveTo(x + w * 0.48, y);
        ctx.lineTo(x + w * 0.52, y);
        ctx.stroke();
      }
      ctx.setLineDash([]);
    }

    function drawPlayer() {
      // Vệt sáng
      player.trail.push({ x: player.x + 25, y: player.y + 70 });
      if (player.trail.length > 15) player.trail.shift();
      player.trail.forEach((p, i) => {
        ctx.fillStyle = `rgba(0, 255, 255, ${i/player.trail.length * 0.8})`;
        ctx.fillRect(p.x - 5, p.y, 10, 20);
      });

      // Xe
      const gradient = ctx.createLinearGradient(player.x, player.y, player.x + player.width, player.y + player.height);
      gradient.addColorStop(0, '#0ff');
      gradient.addColorStop(1, '#f0f');
      ctx.fillStyle = gradient;
      ctx.shadowBlur = 30; ctx.shadowColor = '#0ff';
      ctx.fillRect(player.x, player.y, player.width, player.height);

      // Đèn pha
      ctx.fillStyle = '#fff';
      ctx.fillRect(player.x + 10, player.y - 10, 10, 15);
      ctx.fillRect(player.x + 30, player.y - 10, 10, 15);
    }

    function gameLoop() {
      if (!gameActive) return;

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      draw3DRoad();

      // Sao
      stars.forEach(s => {
        ctx.fillStyle = '#fff';
        ctx.fillRect(s.x, s.y, s.size, s.size);
        s.y += s.speed * (gameSpeed / 5);
        if (s.y > canvas.height) {
          s.y = 0; s.x = Math.random() * canvas.width;
        }
      });

      drawPlayer();
      obstacles.forEach((obs, i) => {
        ctx.shadowBlur = 25; ctx.shadowColor = obs.glow;
        ctx.fillStyle = obs.glow;
        ctx.fillRect(obs.x, obs.y, obs.width, obs.height);
        obs.y += obs.speed;

        if (obs.y > canvas.height) {
          obstacles.splice(i, 1);
          score += 10;
          scoreEl.textContent = score;
          gameSpeed += 0.05;
          speedEl.textContent = (gameSpeed/5).toFixed(1) + 'x';
        }
      });

      particles.forEach((p, i) => {
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x, p.y, p.size, p.size);
        p.x += p.vx; p.y += p.vy; p.life--;
        if (p.life <= 0) particles.splice(i, 1);
      });

      // Va chạm
      obstacles.forEach(obs => {
        if (
          player.x < obs.x + obs.width &&
          player.x + player.width > obs.x &&
          player.y < obs.y + obs.height &&
          player.y + player.height > obs.y
        ) {
          createExplosion(player.x + 25, player.y + 40);
          gameActive = false;
          finalScoreEl.textContent = score;
          if (score > highscore) {
            highscore = score;
            localStorage.setItem('neonHighscore', highscore);
            highscoreEl.textContent = highscore;
          }
          gameOverScreen.style.display = 'block';
          sounds.bgm.pause();
        }
      });

      if (Math.random() < 0.03 + score / 1000) createObstacle();
      requestAnimationFrame(gameLoop);
    }

    // Điều khiển
    document.addEventListener('keydown', e => {
      if (!gameActive) return;
      if (e.key === 'ArrowLeft' && player.x > 80) player.x -= player.speed * 20;
      if (e.key === 'ArrowRight' && player.x < 310) player.x += player.speed * 20;
    });

    // Touch
    let touchX = 0;
    canvas.addEventListener('touchstart', e => { touchX = e.touches[0].clientX; });
    canvas.addEventListener('touchmove', e => {
      if (!gameActive) return;
      const diff = e.touches[0].clientX - touchX;
      player.x = Math.max(80, Math.min(310, player.x + diff));
      touchX = e.touches[0].clientX;
    });

    function restartGame() {
      obstacles = []; particles = []; player.trail = []; score = 0; gameSpeed = 5; gameActive = true;
      player.x = 200;
      scoreEl.textContent = '0';
      speedEl.textContent = '1.0x';
      gameOverScreen.style.display = 'none';
      sounds.bgm.currentTime = 0; sounds.bgm.play();
      gameLoop();
    }

    // Khởi động
    sounds.bgm.play();
    gameLoop();

    // Shake animation
    const style = document.createElement('style');
    style.innerHTML = `@keyframes shake { 0%,100%{transform:translateX(0)} 10%,30%,50%,70%,90%{transform:translateX(-10px)} 20%,40%,60%,80%{transform:translateX(10px)} }`;
    document.head.appendChild(style);
  </script>
</body>
</html>